name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish-pypi:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Verify version matches pyproject.toml
      run: |
        PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        TAG_VERSION=${{ steps.get_version.outputs.VERSION }}
        if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Version in pyproject.toml ($PYPROJECT_VERSION) does not match tag version ($TAG_VERSION)"
          exit 1
        fi
        echo "Version check passed: $PYPROJECT_VERSION"
    
    - name: Build package
      run: python -m build
    
    - name: Check package
      run: twine check dist/*
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        # Uses trusted publishing - no token needed if configured in PyPI
        # If not using trusted publishing, uncomment below and set PYPI_API_TOKEN secret
        # password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true
        verbose: true

  create-release:
    runs-on: ubuntu-latest
    needs: publish-pypi
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Installation
          
          Quick install:
          ```bash
          curl -sSL https://raw.githubusercontent.com/turlockmike/murl/main/install.sh | bash
          ```
          
          Or via pip:
          ```bash
          pip install murl==${{ steps.get_version.outputs.VERSION }}
          ```
          
          ## Changes
          See commit history for details.
        draft: false
        prerelease: false
        generate_release_notes: true

    needs: publish-pypi
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Wait for PyPI availability
      run: |
        echo "Waiting 2 minutes for package to be available on PyPI..."
        sleep 120
    
    - name: Generate Homebrew Formula
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        
        # Download the package from PyPI to get the SHA256
        curl -L -o murl-${VERSION}.tar.gz https://files.pythonhosted.org/packages/source/m/murl/murl-${VERSION}.tar.gz
        SHA256=$(sha256sum murl-${VERSION}.tar.gz | awk '{print $1}')
        
        # Create formula directory
        mkdir -p homebrew-formula
        
        # Generate the formula - simplified version that lets Homebrew handle dependencies
        cat > homebrew-formula/murl.rb << EOF
        class Murl < Formula
          include Language::Python::Virtualenv

          desc "A curl-like CLI tool for interacting with Model Context Protocol (MCP) servers"
          homepage "https://github.com/turlockmike/murl"
          url "https://files.pythonhosted.org/packages/source/m/murl/murl-${VERSION}.tar.gz"
          sha256 "${SHA256}"
          license "MIT"

          depends_on "python@3.12"

          def install
            virtualenv_install_with_resources
          end

          test do
            assert_match "murl", shell_output("#{bin}/murl --version")
          end
        end
        EOF
        
        echo "Generated Homebrew formula:"
        cat homebrew-formula/murl.rb
    
    - name: Upload Homebrew Formula as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: homebrew-formula
        path: homebrew-formula/murl.rb
        retention-days: 90
    
    - name: Publish to Homebrew Tap
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      env:
        HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        
        # Check if token is available
        if [ -z "$HOMEBREW_TAP_TOKEN" ]; then
          echo "HOMEBREW_TAP_TOKEN not set. Skipping tap update."
          echo "To enable automatic tap updates, add HOMEBREW_TAP_TOKEN secret to repository."
          exit 0
        fi
        
        # Clone the tap repository
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Clone tap repo (assumes turlockmike/homebrew-tap exists)
        git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/turlockmike/homebrew-tap.git tap-repo || {
          echo "Failed to clone tap repository. Make sure turlockmike/homebrew-tap exists."
          echo "Create it with: gh repo create turlockmike/homebrew-tap --public"
          exit 0
        }
        
        cd tap-repo
        
        # Create Formula directory if it doesn't exist
        mkdir -p Formula
        
        # Copy the formula
        cp ../homebrew-formula/murl.rb Formula/murl.rb
        
        # Commit and push
        git add Formula/murl.rb
        if git diff --staged --quiet; then
          echo "No changes to formula"
        else
          git commit -m "Update murl to ${VERSION}"
          
          # Detect the default branch
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
          if [ -z "$DEFAULT_BRANCH" ]; then
            # Fallback: try common branch names
            if git show-ref --verify --quiet refs/heads/main; then
              DEFAULT_BRANCH="main"
            elif git show-ref --verify --quiet refs/heads/master; then
              DEFAULT_BRANCH="master"
            else
              echo "Could not determine default branch"
              exit 1
            fi
          fi
          
          git push origin "$DEFAULT_BRANCH" || {
            echo "Failed to push to tap repository"
            exit 1
          }
          echo "âœ“ Successfully updated Homebrew tap"
        fi
    
    - name: Comment on Release with Formula
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const formula = fs.readFileSync('homebrew-formula/murl.rb', 'utf8');
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `## Homebrew Formula Generated\n\nThe Homebrew formula has been generated and is available as an artifact.\n\nTo install from this formula:\n\n\`\`\`bash\nbrew install turlockmike/tap/murl\n\`\`\`\n\nOr install directly:\n\n\`\`\`bash\nbrew install murl.rb\n\`\`\`\n\n<details>\n<summary>Formula content</summary>\n\n\`\`\`ruby\n${formula}\n\`\`\`\n\n</details>`
          });
